{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'template-collection.css' | asset_url | stylesheet_tag }}

{% if section.settings.image_shape == 'blob' %}
  {{ 'mask-blobs.css' | asset_url | stylesheet_tag }}
{%- endif -%}

{%- unless section.settings.quick_add == 'none' -%}
  {{ 'quick-add.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
{%- endunless -%}

{%- if section.settings.quick_add == 'standard' -%}
  <script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- if section.settings.quick_add == 'bulk' -%}
  <script src="{{ 'quick-add-bulk.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quantity-popover.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'price-per-item.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'quick-order-list.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* --- STICKER GRID CUSTOM STYLES --- */
  
  /* Remove Card Backgrounds */
  .section-{{ section.id }}-padding .card,
  .section-{{ section.id }}-padding .card-wrapper,
  .section-{{ section.id }}-padding .card__inner,
  .section-{{ section.id }}-padding .card__content,
  .section-{{ section.id }}-padding .card__media {
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    --color-background: transparent;
    --gradient-background: transparent;
    --shadow-horizontal-offset: 0px;
    --shadow-vertical-offset: 0px;
    --shadow-blur-radius: 0px;
    --shadow-opacity: 0;
  }
  
  /* Kill the ::after pseudo-element that often holds borders */
  .section-{{ section.id }}-padding .card:after,
  .section-{{ section.id }}-padding .card-wrapper:after,
  .section-{{ section.id }}-padding .card__inner:after {
    display: none !important;
  }
  
  .section-{{ section.id }}-padding .media--transparent {
     background-color: transparent !important;
  }

  /* Die-Cut Outline Effect on Images (Optimized) */
  .section-{{ section.id }}-padding .card__media img {
    /* Reduced to 4 shadows for performance, plus hardware acceleration */
    filter: 
        drop-shadow(3px 0 0 white) 
        drop-shadow(-3px 0 0 white) 
        drop-shadow(0 3px 0 white) 
        drop-shadow(0 -3px 0 white)
        drop-shadow(3px 5px 8px rgba(0,0,0,0.2));
        
    will-change: transform, filter; /* Hint to browser */
    transform: translateZ(0); /* Force GPU layer */
    
    transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
    
    /* Ensure image fits nicely */
    object-fit: contain !important;
    padding: 10px; /* Reduced padding to tighten */
  }

  /* Hover Interaction: Pop and Rotate */
  .section-{{ section.id }}-padding .card-wrapper:hover .card__media img {
    transform: scale(1.05) rotate(2deg) translateZ(0);
    filter: 
        drop-shadow(3px 0 0 white) 
        drop-shadow(-3px 0 0 white) 
        drop-shadow(0 3px 0 white) 
        drop-shadow(0 -3px 0 white)
        drop-shadow(6px 12px 16px rgba(0,0,0,0.25));
  }

  /* Info Area: Tighter flex container */
  .section-{{ section.id }}-padding .card__content {
    text-align: center;
    padding-top: 5px; /* Way tighter to the image */
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 4px; /* Minimal gap */
    flex-wrap: wrap; 
  }
  
  /* Shared Sticky Note Style for Text */
  .section-{{ section.id }}-padding .card__heading,
  .section-{{ section.id }}-padding .card-information {
    background: #fff88f; /* Yellow default */
    padding: 8px 12px;
    box-shadow: 2px 2px 4px rgba(0,0,0,0.15);
    color: #000;
    width: auto;
    max-width: 100%;
    transition: transform 0.2s ease;
    border-radius: 1px; /* Slight rounding for paper feel */
  }

  /* Title Specifics */
  .section-{{ section.id }}-padding .card__heading {
    font-size: 1.4rem;
    font-weight: bold;
    margin: 0;
    transform: rotate(-2deg);
    background: #fff88f; /* Yellow */
    z-index: 2;
  }
  
  .section-{{ section.id }}-padding .card__heading a {
    text-decoration: none;
    color: #000;
  }

  /* Main Page Title: Masking Tape Style as the "Tape" */
  .section-{{ section.id }}-padding .collection__title {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* Negative margin to pull the "tape" down onto the "paper" is handled by the elements */
  }

  .section-{{ section.id }}-padding .collection__title .title {
      /* Base: Cute Pink Washi */
      background-color: rgba(255, 182, 193, 0.85); 
      
      /* Pattern: White Polka Dots */
      background-image: 
          radial-gradient(rgba(255,255,255,0.8) 15%, transparent 16%),
          radial-gradient(rgba(255,255,255,0.8) 15%, transparent 16%);
      background-size: 16px 16px; /* Smaller pattern too */
      background-position: 0 0, 8px 8px; 
      
      color: #2a2a2a;
      padding: 10px 40px; 
      display: inline-block;
      max-width: 700px; /* Wide on Desktop */
      position: relative;
      
      /* 3D Floating Tape Effect */
      transform: rotate(-2deg) translateY(22px) translateZ(10px); 
      box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
      
      /* Smooth Translucency */
      backdrop-filter: blur(1.5px);
      
      /* Finer Torn Edge */
      clip-path: polygon(
          0% 5%, 2% 0%, 5% 4%, 8% 0%, 12% 4%, 15% 0%, 19% 5%, 
          22% 0%, 25% 4%, 29% 0%, 33% 4%, 37% 0%, 40% 5%, 
          44% 0%, 47% 4%, 52% 0%, 56% 4%, 60% 0%, 64% 5%, 
          68% 0%, 72% 4%, 76% 0%, 79% 5%, 83% 0%, 87% 4%, 
          91% 0%, 95% 4%, 98% 0%, 100% 5%, 
          
          100% 95%, 98% 100%, 95% 96%, 91% 100%, 87% 96%, 83% 100%, 79% 96%,
          76% 100%, 72% 96%, 68% 100%, 64% 96%, 60% 100%, 56% 96%, 52% 100%,
          47% 96%, 44% 100%, 40% 96%, 37% 100%, 33% 96%, 29% 100%, 25% 96%, 
          22% 100%, 19% 96%, 15% 100%, 12% 96%, 8% 100%, 5% 96%, 2% 100%, 0% 95%
      );
      
      font-size: 1.8rem; 
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px; 
      z-index: 10; 
      margin-bottom: 0;
      line-height: 1.1; 
      border: none;
      text-shadow: 1px 1px 0px rgba(255,255,255,0.4); 
  }

  /* Description: Realistic Binder Paper */
  .section-{{ section.id }}-padding .collection__description {
      position: relative;
      background-color: #fffdf0; 
      color: #2c2c2c;
      padding: 30px 20px 25px 50px; 
      margin: 0 auto 40px auto; 
      max-width: 680px; /* Wide on Desktop */
      
      /* Tighter Lines (20px) + Red Margin */
      background-image: 
        linear-gradient(to right, transparent 39px, #ffb3b3 39px, #ffb3b3 40px, transparent 40px), 
        repeating-linear-gradient(transparent, transparent 19px, #b5d0e2 20px); 
        
      border-radius: 2px; 
      border-left: 1px solid #e0e0e0; 
      
      box-shadow: 
        0 1px 1px rgba(0,0,0,0.05), 
        0 5px 10px rgba(0,0,0,0.05),
        -1px 0 0 rgba(0,0,0,0.02) inset; 
        
      transform: none; 
      
      font-size: 0.95rem; 
      line-height: 20px; 
      text-align: center; 
      z-index: 5;
      font-weight: 500;
  }
  
  /* Mobile Overrides: Keep Compact "Bookmarker" Feel */
  @media screen and (max-width: 750px) {
      .section-{{ section.id }}-padding .collection__title .title {
          max-width: 320px; 
          padding: 10px 30px;
      }
      .section-{{ section.id }}-padding .collection__description {
          max-width: 300px;
      }
  }

  /* Binder Holes */
  .section-{{ section.id }}-padding .collection__description::after {
      content: '';
      position: absolute;
      top: 0;
      left: 15px; /* Closer to edge */
      height: 100%;
      width: 15px;
      background-image: radial-gradient(circle, #222 4px, rgba(0,0,0,0.1) 5px, transparent 6px); /* Smaller holes */
      background-size: 100% 25px; /* More frequent holes or just pattern */
      background-repeat: space no-repeat;
      background-position: center 10%; 
      opacity: 0.15; 
  }
  
  /* Remove the old fake tape */
  .section-{{ section.id }}-padding .collection__description::before {
      display: none;
  }

  /* Price/Info Specifics - Cleaned Up */
  .section-{{ section.id }}-padding .card-information {
    margin: 5px 0 0 0;
    transform: none; /* No rotation */
    background: transparent; /* No sticky note background */
    box-shadow: none;
    font-weight: bold;
    font-family: var(--font-body-family);
    z-index: 1;
    text-align: center;
    padding-bottom: 10px; /* Reduced to bring buttons closer */
    line-height: 1.2;
  }
  
  /* Tighter Spacing using Standard Grid Variables */
  .section-{{ section.id }}-padding .grid {
     /* Override standard Shopify grid gap variables locally */
     --grid-desktop-horizontal-spacing: 10px;
     --grid-desktop-vertical-spacing: 30px;
     --grid-mobile-horizontal-spacing: 10px;
     --grid-mobile-vertical-spacing: 30px;
     
     /* Ensure it respects the gap */
     column-gap: var(--grid-mobile-horizontal-spacing);
     row-gap: var(--grid-mobile-vertical-spacing);
     margin-bottom: 30px;
  }
  
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding .grid {
      column-gap: var(--grid-desktop-horizontal-spacing);
      row-gap: var(--grid-desktop-vertical-spacing);
    }
  }

  /* Hover effects on the text notes */
  .section-{{ section.id }}-padding .card-wrapper:hover .card__heading {
     transform: rotate(0deg) scale(1.05);
     z-index: 10;
  }
  
  .section-{{ section.id }}-padding .card-wrapper:hover .card-information {
     transform: rotate(0deg) scale(1.05);
     z-index: 10;
  }

  /* Randomize rotations slightly using nth-child */
  .section-{{ section.id }}-padding .grid__item:nth-child(even) .card__heading {
    transform: rotate(2deg);
  }
  .section-{{ section.id }}-padding .grid__item:nth-child(even) .card-information {
    transform: none;
    background: transparent !important; /* Force remove blue note */
  }
    /* Selection State */
    .sticker-select-wrapper {
      position: relative; /* CRITICAL: Anchor for absolute overlay */
      overflow: visible; /* Allow post-its to hang out */
      width: 100%;
      height: 100%;
    }

    .sticker-select-wrapper.is-selected .card__media {
      /* Floating effect only, no glow */
      transform: translateY(-5px);
      transition: transform 0.3s ease;
    }

    .sticker-select-wrapper.is-selected .card__media img {
      /* No Glow, just scale */
      transform: scale(1.02);
      /* Subtle desaturation to make stamp pop? Optional. Let's keep it vibrant. */
    }
    
    /* JS-Injected Random Stamp */
    .sticker-stamp {
      position: absolute;
      /* Responsive Size: 25% of card, but between 50px and 90px */
      width: clamp(50px, 28%, 90px);
      height: clamp(50px, 28%, 90px); 
      
      /* Visuals handled by IMG now */
      display: flex;
      align-items: center;
      justify-content: center;
      
      /* Stamp Look: Circular Red Seal */
      border: 3px solid #d32f2f; /* Red Ink Color */
      border-radius: 50%;
      background-color: rgba(211, 47, 47, 0.05); /* Very faint red tint inside */
      padding: 8px; /* Space for the bear inside the circle */
      box-shadow: inset 0 0 0 1px rgba(211, 47, 47, 0.2); /* Inner ring effect */

      /* Opaque to be visible on dark bg */
      mix-blend-mode: normal; 
      
      pointer-events: none;
      z-index: 70; 
      
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .sticker-stamp.is-visible {
       opacity: 0.9; /* Ink isn't solid */
       transform: scale(1) !important; 
    }

    /* Hide Price in this section only */
    .card-information .price {
      display: none !important;
    }
    
    /* Ensure trigger covers everything for "Click to Add" */
    .selection-trigger {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 55; /* Above card, below controls */
        cursor: pointer;
    }

    /* Quantity Controls (Post-it style) - Permanent Visibility */
    .quantity-note {
      position: absolute;
      bottom: -15px; /* Overlap the card slightly */
      left: 50%;
      transform: translateX(-50%);
      padding: 0;
      background: transparent;
      box-shadow: none;
      
      display: flex;
      align-items: center;
      gap: 5px; 
      z-index: 60; 
      width: max-content;
      pointer-events: auto;
    }

    /* Common Note Style */
    .qty-note-item {
      width: 50px; /* Bigger! */
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 2rem; /* Bigger font */
      color: #000;
      box-shadow: 2px 3px 6px rgba(0,0,0,0.15);
      font-family: var(--font-heading-family); 
      transition: transform 0.2s;
      border-radius: 2px;
    }

    /* Specific Styles based on image */
    .qty-btn-minus {
      background: #d0eaef; /* Light Blue */
      border: none;
      transform: rotate(-3deg);
      cursor: pointer;
    }
    .qty-btn-minus:hover { transform: rotate(-3deg) scale(1.1); }

    .qty-display-wrapper {
      background: #a9e0fa; /* Slightly darker blue */
      transform: rotate(0deg); /* Straight */
      z-index: 2; /* Sit on top if overlap */
    }

    .qty-btn-plus {
      background: #a9e0fa; /* Same blue as center */
      border: none;
      transform: rotate(3deg);
      cursor: pointer;
    }
    .qty-btn-plus:hover { transform: rotate(3deg) scale(1.1); }
    
    .qty-display {
        background: transparent;
        font-weight: 800;
        font-size: 1.1rem;
    }

    /* Adjust Card Info spacing since price is gone */
    /* Floating Tracker (Pink Sticky Note) */
    .sticker-tracker {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      
      background: #fff0f5; /* Lavender Blush (Pink) */
      border: none;
      border-radius: 2px;
      
      padding: 15px 20px;
      width: 260px;
      
      box-shadow: 2px 4px 10px rgba(0,0,0,0.15);
      transform: rotate(-2deg);
      
      display: none; /* JS toggles flex */
      flex-direction: column;
      align-items: center;
      gap: 10px;
      
      font-family: var(--font-heading-family);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    /* MOBILE OPTIMIZATIONS */
    @media screen and (max-width: 750px) {
        /* Smaller Buttons */
        .qty-note-item {
            width: 36px !important;
            height: 36px !important;
            font-size: 1.4rem !important; /* Readable but smaller container */
        }
        .quantity-note {
            bottom: -10px !important; /* Tuck tighter */
            gap: 4px !important;
        }
        
        /* Bigger Stickers */
        .card__media img {
            transform: scale(1.15) !important; /* Zoom in slightly */
        }
        
        /* Responsive Stamp */
        .sticker-stamp {
             width: clamp(40px, 22%, 70px) !important;
             height: clamp(40px, 22%, 70px) !important;
        }
    }
    
    .sticker-tracker.is-complete {
        transform: rotate(0deg) scale(1.05); /* Straighten and pop when ready */
    }

    /* Tape visual at top */
    .tracker-tape-visual {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%) rotate(1deg);
        width: 80px;
        height: 25px;
        background: rgba(255, 255, 255, 0.6);
        border-left: 1px dashed rgba(0,0,0,0.1);
        border-right: 1px dashed rgba(0,0,0,0.1);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .tracker-title {
        font-size: 1.4rem;
        font-weight: 800;
        color: #d14d72; /* Darker Pink/Red */
        margin-top: 5px;
    }

    .tracker-slots {
        display: flex;
        gap: 10px;
        margin: 5px 0;
    }

    .tracker-slot img {
        width: 40px; 
        height: 40px;
        object-fit: contain;
        opacity: 0.2; /* Ghost Bear */
        transition: all 0.3s ease;
        filter: grayscale(100%);
    }

    .tracker-slot.filled img {
        opacity: 1; /* Real Bear */
        filter: none;
        transform: scale(1.1) rotate(5deg);
    }
    
    .tracker-status-text {
        font-size: 0.9rem;
        color: #888;
        font-weight: bold;
    }

    .tracker-cta {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 20px;
        background: #b4f0c8; /* Mint Green */
        color: #2a4a3a;
        font-weight: 800;
        font-size: 1rem;
        cursor: not-allowed;
        opacity: 0.6;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .tracker-cta:not([disabled]) {
        cursor: pointer;
        opacity: 1;
        box-shadow: 0 4px 0 #8dc9a0; /* 3D Button Press */
        transform: translateY(-2px);
    }
    .tracker-cta:not([disabled]):active {
        box-shadow: 0 0 0 #8dc9a0;
        transform: translateY(2px);
    }
    .section-{{ section.id }}-padding .card-information {
      margin: 5px auto 0 auto; /* Center the block */
      width: fit-content; /* Shrink to text size */
      max-width: 100%; /* Prevent overflow */
      transform: none; 
      background: transparent; 
      box-shadow: none;
      font-weight: bold;
      font-family: var(--font-body-family);
      z-index: 1;
      text-align: center;
      padding-bottom: 10px; 
      line-height: 1.2;
      position: relative; /* Anchor for price tape */
    }
    
    /* Washi Tape Price Tag */
    .sticker-price-tape {
      position: absolute;
      top: -15px; 
      right: -15px; 
      z-index: 10; /* Just above text */
      
      background-color: rgba(180, 240, 200, 0.9); /* Mint Green Washi */
      color: #2a4a3a; /* Dark Green Text */
      padding: 4px 12px;
      
      font-family: var(--font-heading-family); 
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: 0.5px;
      
      /* transform handled by inline style for randomization */
      box-shadow: 1px 2px 4px rgba(0,0,0,0.15);
      
      /* Torn Edges */
      clip-path: polygon(
        2% 0%, 98% 1%, 100% 5%, 
        100% 95%, 98% 100%, 2% 99%, 0% 95%, 
        0% 5%
      );
      transition: transform 0.2s;
    }
    
    .tracker-tape {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 20px;
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .tracker-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .tracker-count {
      font-size: 2rem;
      font-weight: 800;
      text-align: center;
      margin: 5px 0;
      color: #333;
    }
    
    .tracker-subtext {
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 10px;
      line-height: 1.3;
    }
    
    .tracker-btn {
      width: 100%;
      padding: 10px;
      background: #000;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      transition: background 0.2s;
    }
    .tracker-btn:hover {
      background: #333;
    }
    .tracker-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    /* State: Complete */
    .sticker-tracker.is-complete {
      border-color: #ffd700;
      background: #fffbe6;
    }
    .sticker-tracker.is-complete .tracker-count {
      color: #d4af37;
    }

{%- endstyle -%}

{%- liquid
  assign products_to_display = section.settings.collection.all_products_count

  if section.settings.collection.all_products_count > section.settings.products_to_show
    assign products_to_display = section.settings.products_to_show
    assign more_in_collection = true
  endif
-%}

<div class="color-{{ section.settings.color_scheme }} isolate gradient">
  <div class="collection section-{{ section.id }}-padding">
    
    <div class="collection__title title-wrapper title-wrapper--no-top-margin page-width center">
       {%- if section.settings.title != blank -%}
        <h2 class="title inline-richtext {{ section.settings.heading_size }}">
          {{ section.settings.title }}
        </h2>
        <div class="collection__description">
          {%- if section.settings.description != blank -%}
            {{ section.settings.description }}
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>

    <!-- Sticker Grid -->
    <div class="page-width">
      <ul class="grid product-grid grid--{{ section.settings.columns_desktop }}-col-desktop grid--{{ section.settings.columns_mobile }}-col-tablet-down" role="list">
        {%- for product in section.settings.collection.products limit: section.settings.products_to_show -%}
          <li class="grid__item">
            <!-- Wrapper with Data Attribute for Selection -->
            <div class="sticker-select-wrapper" data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                
                <!-- Price Tape moved to card-product.liquid -->
                
                {% render 'card-product',
                  card_product: product,
                  media_aspect_ratio: section.settings.image_ratio,
                  image_shape: section.settings.image_shape,
                  show_secondary_image: section.settings.show_secondary_image,
                  show_vendor: section.settings.show_vendor,
                  show_rating: section.settings.show_rating,
                  section_id: section.id
                %}

                <!-- Quantity Controls Overlay -->
                <!-- We remove the full-cover click to allow natural hover, but maybe hijacking image click is still good? 
                     User specifically asked for +1 -1 buttons. Let's put those in. -->
                <div class="quantity-note" id="qty-note-{{ product.selected_or_first_available_variant.id }}">
                   <button type="button" class="qty-note-item qty-btn-minus" onclick="updateQty(this, -1)">-</button>
                   <div class="qty-note-item qty-display-wrapper">
                       <span class="qty-display" data-current="0">0</span>
                   </div>
                   <button type="button" class="qty-note-item qty-btn-plus" onclick="updateQty(this, 1)">+</button>
                </div>
                
                <!-- Helper overlay triggers +1 if clicked -->
                 <div class="selection-trigger" onclick="initialClick(this)"></div>

            </div>
          </li>
        {%- endfor -%}
      </ul>
    </div>
    
    <!-- Floating Tracker (Pink Sticky Note) -->
    <div class="sticker-tracker" id="bundle-tracker">
      <div class="tracker-tape-visual"></div>
      <div class="tracker-title">✨ 3 FOR €5 ✨</div>
      
      <div class="tracker-slots">
        <!-- Bear Slots -->
        <div class="tracker-slot">
            <img src="{{ 'bear-line-icon.png' | asset_url }}" alt="Slot 1" width="40" height="40">
        </div>
        <div class="tracker-slot">
            <img src="{{ 'bear-line-icon.png' | asset_url }}" alt="Slot 2" width="40" height="40">
        </div>
        <div class="tracker-slot">
            <img src="{{ 'bear-line-icon.png' | asset_url }}" alt="Slot 3" width="40" height="40">
        </div>
      </div>
      
      <div class="tracker-status-text">Pick <span id="slots-left">3</span> more!</div>
      
      <button class="tracker-cta" id="tracker-cta" disabled>
        Add Bundle - €5.00
      </button>
    </div>

  </div>
</div>

<script>
  window.stickerState = {
    items: {}, // Map variantId -> quantity
    required: 3,
    stampUrl: "{{ 'bear-line-icon.png' | asset_url }}" 
  };

  // If user clicks the image directly
  window.initialClick = function(trigger) {
      const wrapper = trigger.closest('.sticker-select-wrapper');
      const qtyNote = wrapper.querySelector('.quantity-note');
      const display = qtyNote.querySelector('.qty-display');
      
      // If we want click to ALWAYS add 1, or toggle? User said "add it to the cart".
      // Usually that implies ADD.
      window.updateQty(qtyNote.querySelector('.qty-btn-plus'), 1);
  };

  window.addRandomStamp = function(wrapper) {
      // Check if stamp exists
      if (wrapper.querySelector('.sticker-stamp')) return;
      
      const stamp = document.createElement('div');
      stamp.classList.add('sticker-stamp');
      
      const img = document.createElement('img');
      img.src = window.stickerState.stampUrl;
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      // Apply Red Pigment Ink Filter (High Contrast/Brightness for visibility on dark bg without glow)
      img.style.filter = 'invert(20%) sepia(90%) saturate(4000%) hue-rotate(350deg) brightness(120%) contrast(150%)';
      
      // Fallback if image missing
      img.onerror = function() {
         stamp.innerText = '★';
         stamp.style.fontSize = '3rem';
         stamp.style.color = '#d32f2f';
         stamp.style.border = '3px dotted #d32f2f';
         stamp.style.borderRadius = '50%';
         stamp.style.display = 'flex';
         stamp.style.alignItems = 'center';
         stamp.style.justifyContent = 'center';
         img.remove(); // Remove broken image
      };
      
      stamp.appendChild(img);
      
      // Random Params
      const randomRot = Math.floor(Math.random() * 60) - 30; // -30 to 30 deg
      const randomTop = Math.floor(Math.random() * 40) + 30; // 30% to 70%
      const randomLeft = Math.floor(Math.random() * 40) + 30; // 30% to 70%
      
      stamp.style.top = randomTop + '%';
      stamp.style.left = randomLeft + '%';
      stamp.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg) scale(0.5)`; // Init scale small
      
      wrapper.appendChild(stamp);
      
      // Animate in
      requestAnimationFrame(() => {
         stamp.style.opacity = '0.9'; 
         stamp.style.transform = `translate(-50%, -50%) rotate(${randomRot}deg) scale(1)`; 
      });
  };

  // JS alignment removed - using native DOM placement in card-product.liquid
  
  // Clean up any old listeners if page doesn't refresh (Liquid/Section rendering handles refresh usually)

  window.removeStamp = function(wrapper) {
      const stamp = wrapper.querySelector('.sticker-stamp');
      if (stamp) {
          stamp.remove();
      }
  };

  window.updateTrackerUI = function() {
      // Calculate total
      let total = 0;
      for (let id in window.stickerState.items) {
          total += window.stickerState.items[id];
      }
      
      const tracker = document.getElementById('bundle-tracker');
      const slots = tracker ? tracker.querySelectorAll('.tracker-slot') : [];
      const statusText = tracker ? tracker.querySelector('.tracker-status-text') : null;
      const cta = document.getElementById('tracker-cta');
      const slotsLeftSpan = document.getElementById('slots-left');

      if (!tracker) return;

      if (total > 0) {
          tracker.style.display = 'flex';
      } else {
          tracker.style.display = 'none';
      }

      // Update Slots (Bear Logic)
      slots.forEach((slot, index) => {
          if (index < total) {
              slot.classList.add('filled');
          } else {
              slot.classList.remove('filled');
          }
      });

      // Update Text & Button
      if (total >= 3) {
          tracker.classList.add('is-complete');
          if (statusText) statusText.innerText = "YAY! Bundle Complete!";
          if (cta) {
              cta.removeAttribute('disabled');
              cta.innerText = "Add Bundle - €5.00";
          }
      } else {
          tracker.classList.remove('is-complete');
          const left = 3 - total;
          if (slotsLeftSpan) slotsLeftSpan.innerText = left;
          if (statusText) statusText.innerHTML = `Pick <span id="slots-left">${left}</span> more!`;
          if (cta) {
              cta.setAttribute('disabled', 'true');
              cta.innerText = "Select 3 items";
          }
      }
  };

  window.updateQty = function(btn, change) {
    const wrapper = btn.closest('.sticker-select-wrapper');
    const variantId = wrapper.dataset.variantId;
    const qtyNote = wrapper.querySelector('.quantity-note');
    const display = qtyNote.querySelector('.qty-display');
    const cardWrapper = wrapper.querySelector('.card-wrapper');

    let current = parseInt(display.dataset.current || 0);
    let newQty = current + change;
    
    if (newQty < 0) newQty = 0;
    
    // Update local UI
    display.innerText = newQty;
    display.dataset.current = newQty;
    
    // Update State
    if (newQty > 0) {
        window.stickerState.items[variantId] = newQty;
        wrapper.classList.add('is-selected');
        qtyNote.classList.add('is-active');
        
        // Add Stamp if not exists
        window.addRandomStamp(wrapper);
        
    } else {
        delete window.stickerState.items[variantId];
        wrapper.classList.remove('is-selected');
        qtyNote.classList.remove('is-active');
        
        // Remove Stamp
        window.removeStamp(wrapper);
    }
    // Verify tracker state
    if (window.updateTrackerUI) window.updateTrackerUI();
  };
  
  // Initialize Tracker on Load
  document.addEventListener('DOMContentLoaded', () => {
      // Create initial state if needed or just sync UI
      if (window.updateTrackerUI) window.updateTrackerUI();
  });

  window.addBundleToCart = async function() {
    const btn = document.getElementById('tracker-cta');
    const originalText = btn.innerText;
    btn.innerText = 'Adding...';
    btn.disabled = true;

    // Convert keys/values to items array
    const items = Object.entries(window.stickerState.items).map(([id, qty]) => ({
      id: parseInt(id),
      quantity: qty
    }));
    
    if (items.length === 0) {
        console.error('No items');
        btn.innerText = 'Select items first';
        return;
    }

    try {
      const response = await fetch(window.Shopify.routes.root + 'cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: items })
      });

      const data = await response.json();
      
      if (data.items) {
          btn.innerText = 'Added!';
          window.location.href = '/cart';
      } else {
          console.error('Error:', data);
          alert('Failed to add: ' + (data.description || 'Unknown error'));
          btn.innerText = 'Error';
          btn.disabled = false;
      }
    } catch (error) {
      console.error(error);
      btn.innerText = 'Error';
      btn.disabled = false;
      setTimeout(() => btn.innerText = originalText, 2000);
    }
  };
  
  // Attach event listener to new CTA
  document.addEventListener('click', function(e) {
      if(e.target && e.target.id == 'tracker-cta') {
          window.addBundleToCart();
      }
  });
</script>

{% schema %}
{
  "name": "Sticker Grid",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 50,
      "step": 1,
      "default": 12,
      "label": "Stickers to show"
    },     
    {
      "type": "inline_richtext",
      "id": "title",
      "default": "Stickers",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "description",
      "default": "<p>Tap + to build your bundle!</p>",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h2", "label": "Small" },
        { "value": "h1", "label": "Medium" },
        { "value": "h0", "label": "Large" }
      ],
      "default": "h1",
      "label": "Heading Size"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3,
      "label": "Columns (Desktop)"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 column"
        },
        {
          "value": "2",
          "label": "2 columns"
        }
      ],
      "default": "2",
      "label": "Columns (Mobile)"
    },    
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "Show second image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "Show rating"
    },
    {
       "type": "select",
       "id": "image_ratio",
       "options": [
         { "value": "adapt", "label": "Adapt to image" },
         { "value": "portrait", "label": "Portrait" },
         { "value": "square", "label": "Square" }
       ],
       "default": "adapt",
       "label": "Image ratio"
    },
    {
       "type": "select",
       "id": "image_shape",
       "options": [
         { "value": "default", "label": "Default" },
         { "value": "arch", "label": "Arch" },
         { "value": "blob", "label": "Blob" },
         { "value": "chevronleft", "label": "Chevron Left" },
         { "value": "chevronright", "label": "Chevron Right" },
         { "value": "diamond", "label": "Diamond" },
         { "value": "parallelogram", "label": "Parallelogram" },
         { "value": "round", "label": "Round" }
       ],
       "default": "default",
       "label": "Image shape"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    },
    {
       "type": "color_scheme",
       "id": "color_scheme",
       "label": "Color Scheme",
       "default": "scheme-1"
    }
  ],
  "presets": [
    {
      "name": "Sticker Grid"
    }
  ]
}
{% endschema %}
