{%- style -%}
  .sticker-wall-section {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
    overflow: hidden; /* Hide stickers dragged deeply offscreen */
    position: relative;
    background-color: {{ section.settings.background_color | default: 'transparent' }};
  }

  .sticker-canvas {
    position: relative;
    width: 95%; /* Leave some margin */
    max-width: 1200px;
    height: 70vh; /* Contained on one screen */
    min-height: 500px;
    margin: 20px auto;
    overflow: hidden; /* Keep them inside */
    
    /* Brown Paper Look (Semi-Transparent) */
    background: linear-gradient(180deg, rgba(248, 239, 212, 0.85) 0%, rgba(230, 216, 182, 0.85) 100%);
    backdrop-filter: blur(2px); /* Slight blur behind */
    border: 1px solid rgba(212, 197, 157, 0.8);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1), inset 0 0 40px rgba(0, 0, 0, 0.05); /* Inset shadow for depth */
    border-radius: 4px; /* Sharper corners for paper */
    
    /* Cut corner for Peel Effect */
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 100px), calc(100% - 100px) 100%, 0 100%);
  }

  .sticker-wrapper {
    position: absolute; /* Free movement */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Start center-ish before scatter */
    cursor: grab;
    user-select: none;
    touch-action: none;
    transition: transform 0.1s linear;
    z-index: 1;
    width: auto;
  }

  .sticker-wrapper:active {
    cursor: grabbing;
    z-index: 100;
    transition: none;
  }

  .sticker-image {
    width: 140px; /* Slightly smaller for mobile clutter */
    height: auto;
    display: block;
    pointer-events: none;
    filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2)); 
    transition: filter 0.2s ease, transform 0.2s ease;
  }
  
  @media screen and (min-width: 750px) {
    .sticker-image {
      width: 200px;
    }
  }
  
  /* Hover effect: lift up slightly */
  .sticker-wrapper:hover .sticker-image {
    filter: drop-shadow(5px 10px 15px rgba(0,0,0,0.3));
    transform: scale(1.05);
  }

  /* Hover effect: lift up slightly */
  .sticker-wrapper:hover .sticker-image {
    filter: drop-shadow(5px 10px 15px rgba(0,0,0,0.3));
    transform: scale(1.05);
  }

  /* Peel Away Button */
  .sticker-peel {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 100px;
    height: 100px;
    /* Create the folded triangle look */
    background: linear-gradient(135deg, transparent 50%, #dccba8 50%, #cbb890 100%);
    box-shadow: -5px -5px 15px rgba(0,0,0,0.15); /* Shadow placed behind the curl */
    display: flex;
    justify-content: flex-end; /* Align text to bottom right of box (which is the triangle center) */
    align-items: flex-end;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    z-index: 10;
    /* Since we are outside the clipped canvas (actually inside, but we need to fake it if clipped)
       Wait, if we are INSIDE the canvas, we get clipped too!
       CRITICAL: Use a separate container in HTML? 
       Or place .sticker-peel OUTSIDE .sticker-canvas in the markup, but absolutely positioned relative to .sticker-wall-section?
       If outside, we need to match position.
       Easier: Don't clip the canvas. Use a mask or just overlay the peel on top?
       If overlay, we see the paper underneath.
       Let's use clip-path on the canvas, and place the peel OUTSIDE the canvas.
       Markup change required.
    */
  }
  
  /* Correction: The peel needs to be inside the .sticker-wall-section container, matching the canvas position.
     The canvas has margin: 20px auto. 
     This makes positioning tricky if window resize.
     Better approach: Wrap canvas in a relative container.
  */
  
  .sticker-container-wrapper {
    position: relative;
    max-width: 1200px;
    width: 95%;
    margin: 20px auto;
  }
  
  /* The Paper Canvas */
  .sticker-wall-section .sticker-canvas {
    margin: 0;
    width: 100%;
    /* Default Clip (Corner 60px to match small peel) */
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 60px), calc(100% - 60px) 100%, 0 100%);
    transition: clip-path 0.4s cubic-bezier(0.25, 1, 0.5, 1);
  }

  /* When hovering the Button, peel the paper back significantly */
  .sticker-peel:hover + .sticker-canvas {
    clip-path: polygon(0 0, 100% 0, 100% calc(100% - 150px), calc(100% - 150px) 100%, 0 100%);
  }

  .sticker-peel {
    position: absolute;
    bottom: -1px; 
    right: -1px;  
    width: 60px; /* Hidden state */
    height: 60px;
    
    /* Transparent Tape / Acetate Look */
    background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0.1) 100%);
    backdrop-filter: blur(2px);
    border-top: 1px solid rgba(255,255,255,0.3);
    border-left: 1px solid rgba(255,255,255,0.1);
    
    display: flex;
    align-items: center; 
    justify-content: center; 
    padding: 0;
    
    text-decoration: none;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    z-index: 10;
    border-top-left-radius: 60px; 
    overflow: hidden;
  }
  
  .sticker-peel:hover {
    width: 150px;
    height: 150px;
    background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.3) 100%);
    box-shadow: -4px -4px 15px rgba(0,0,0,0.15);
  }
  
  .sticker-peel span {
    /* Position the text in the bottom-right triangle quarter */
    transform: rotate(-45deg) translate(20px, 20px); 
    font-family: var(--font-heading-family); 
    font-weight: 800;
    font-size: 2.4rem;
    color: #4e342e; /* Brown Ink */
    line-height: 1;
    text-align: center;
    text-transform: lowercase;
    letter-spacing: 2px;
    opacity: 0; 
    transition: all 0.3s ease;
    pointer-events: none;
    text-shadow: 0 1px 1px rgba(255,255,255,0.5);
    white-space: nowrap;
  }
  
  .sticker-peel:hover span {
    opacity: 1;
    /* Center visually in the triangle */
    transform: rotate(-45deg) translate(20px, 20px); 
    transition-delay: 0.1s; 
  }
  
  /* Mobile: Always Unpeeled (Half Size) */
  @media screen and (max-width: 749px) {
    .sticker-peel {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.3) 100%);
      box-shadow: -2px -2px 6px rgba(0,0,0,0.15);
    }
    .sticker-peel span {
      opacity: 1;
      font-size: 1.2rem; 
      transform: rotate(-45deg) translate(5px, 5px);
      letter-spacing: 0.5px;
    }
    .sticker-wall-section .sticker-canvas {
      clip-path: polygon(0 0, 100% 0, 100% calc(100% - 80px), calc(100% - 80px) 100%, 0 100%) !important;
    }
  }
  
  /* Reuse Packing Tape Header */
  .masking-tape-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 5px;
    padding: 10px;
  }
  
  /* ... existing masking tape styles ... */
  /* NOPE, replacer tool needs exact context. I will stick to the block I am replacing. */
{%- endstyle -%}

<div class="sticker-wall-section">
  <div class="page-width">
    {%- if section.settings.title != blank -%}
      <div class="masking-tape-wrapper">
        <h2 class="title inline-richtext {{ section.settings.heading_size }} center masking-tape-label">
          {{ section.settings.title }}
        </h2>
      </div>
    {%- endif -%}
  </div>

  <div class="sticker-container-wrapper">
    {%- if section.settings.collection != blank -%}
      <a href="{{ section.settings.collection.url }}" class="sticker-peel">
        <span>see all</span>
      </a>
    {%- endif -%}

    <div class="sticker-canvas" id="StickerCanvas-{{ section.id }}">
      {%- for product in section.settings.collection.products limit: section.settings.products_to_show -%}
          <div class="sticker-wrapper" data-href="{{ product.url }}">
              <img
                srcset="{%- if product.featured_media.width >= 165 -%}{{ product.featured_media | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if product.featured_media.width >= 360 -%}{{ product.featured_media | image_url: width: 360 }} 360w,{%- endif -%}"
                src="{{ product.featured_media | image_url: width: 360 }}"
                sizes="180px"
                alt="{{ product.featured_media.alt | escape }}"
                loading="lazy"
                width="{{ product.featured_media.width }}"
                height="{{ product.featured_media.height }}"
                class="sticker-image"
              >
          </div>
      {%- else -%}
          {%- for i in (1..6) -%}
              <div class="sticker-wrapper">
                   {{ 'product-' | append: i | placeholder_svg_tag: 'sticker-image' }}
              </div>
          {%- endfor -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('StickerCanvas-{{ section.id }}');
    const stickers = canvas.querySelectorAll('.sticker-wrapper');
    
    // Scatter Stickers with Overlap Protection
    const placedStickers = [];
    const containerAspect = canvas.clientWidth / canvas.clientHeight;
    // Normalized threshold: Assume sticker is roughly 15% of width. 
    // Adjust y-threshold by aspect ratio to keep circles circular.
    const thresholdX = 16; 
    const thresholdY = 16 * containerAspect; 

    stickers.forEach(sticker => {
        let randX, randY, safe = false;
        let attempts = 0;

        // Try to find a safe spot
        while (!safe && attempts < 50) {
            attempts++;
            // Tightened range: 10% to 70%
            // This ensures mostly fully visible stickers even if they are large
            randX = Math.floor(Math.random() * 60) + 10; 
            randY = Math.floor(Math.random() * 60) + 10; 
            
            safe = true;
            for (let p of placedStickers) {
                // Simple distance check (normalized to X-axis units somewhat)
                // We just check if they are too close in either dimension roughly
                // Use Euclidean distance with aspect correction for better circular spacing
                const dx = randX - p.x;
                const dy = (randY - p.y) / containerAspect; // weighted by aspect
                
                // If distance is less than sticker size (~16%)
                if (Math.hypot(dx, dy) < 14) { 
                    safe = false;
                    break;
                }
            }
        }
        
        // If we failed 50 times, just place it anyway (it's a sticker pile after all)
        
        placedStickers.push({x: randX, y: randY});

        const randRotate = Math.floor(Math.random() * 40) - 20; // -20 to 20 deg
        
        sticker.style.left = `${randX}%`;
        sticker.style.top = `${randY}%`;
        sticker.style.transform = `rotate(${randRotate}deg)`; 
    });

    stickers.forEach(sticker => {
      let isDragging = false;
      let startX, startY, initialTranslateX = 0, initialTranslateY = 0;
      let currentTranslateX = 0, currentTranslateY = 0;

      sticker.addEventListener('mousedown', startDrag);
      sticker.addEventListener('touchstart', startDrag, {passive: false});

      function startDrag(e) {
        if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        } else {
          startX = e.clientX;
          startY = e.clientY;
          e.preventDefault(); 
        }
        
        isDragging = false; // Reset to ensure it's a click unless moved

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);
      }

      function drag(e) {
        const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
        const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
        
        const dx = clientX - startX;
        const dy = clientY - startY;
        
        // Small threshold to allow clicking
        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
            isDragging = true;
        }
        
        if (isDragging) {
             if (e.type === 'touchmove') e.preventDefault(); 
             currentTranslateX = initialTranslateX + dx;
             currentTranslateY = initialTranslateY + dy;
             
             // Use 'translate' property to move without overwriting the 'transform: rotate(...)'
             sticker.style.translate = `${currentTranslateX}px ${currentTranslateY}px`;
        }
      }

      function endDrag(e) {
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('mouseup', endDrag);
        document.removeEventListener('touchend', endDrag);

        if (isDragging) {
           initialTranslateX = currentTranslateX;
           initialTranslateY = currentTranslateY;
        } else {
           // Click action (navigate)
           const url = sticker.dataset.href;
           if (url) window.location.href = url;
        }
      }
    });
  });
</script>

{% schema %}
{
  "name": "Sticker Wall",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "default": "STICKERS",
      "label": "Heading"
    },
    {
       "type": "select",
       "id": "heading_size",
       "options": [
         { "value": "h2", "label": "Small" },
         { "value": "h1", "label": "Medium" },
         { "value": "h0", "label": "Large" }
       ],
       "default": "h1",
       "label": "Heading Size"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 12,
      "label": "Stickers to show"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "transparent"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Sticker Wall"
    }
  ]
}
{% endschema %}
